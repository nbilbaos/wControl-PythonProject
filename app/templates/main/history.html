{% extends "base.html" %}

{% block title %}Reporte Clínico - WeightControl{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/history.css') }}">
{% endblock %}

{% block content %}
<div class="container py-4">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3 no-print">
        <div>
            <h2 class="fw-bold text-dark mb-0"><i class="bi bi-file-medical text-primary me-2"></i>Reporte Clínico</h2>
            <p class="text-muted mb-0">Vista profesional de seguimiento.</p>
        </div>

        <div class="d-flex flex-wrap gap-2 align-items-center">
            <form action="{{ url_for('main.full_history') }}" method="GET" class="d-flex gap-2 align-items-center" id="filterForm">
                <select name="filter" class="form-select form-select-sm" id="timeFilter" onchange="toggleCustomDates()">
                    <option value="3m" {% if current_filter == '3m' %}selected{% endif %}>Últimos 3 Meses</option>
                    <option value="6m" {% if current_filter == '6m' %}selected{% endif %}>Últimos 6 Meses</option>
                    <option value="all" {% if current_filter == 'all' %}selected{% endif %}>Historial Completo</option>
                    <option value="custom" {% if current_filter == 'custom' %}selected{% endif %}>Rango Personalizado</option>
                </select>

                <div id="customDateInputs" class="d-flex gap-1" style="display: none;">
                    <input type="date" name="start_date" class="form-control form-control-sm" value="{{ request.args.get('start_date') }}">
                    <input type="date" name="end_date" class="form-control form-control-sm" value="{{ request.args.get('end_date') }}">
                </div>

                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="bi bi-filter"></i>
                </button>
            </form>

            <div class="vr mx-2"></div>

            <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm btn-outline-secondary rounded-pill">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
            <button id="btnDownloadPDF" class="btn btn-sm btn-danger rounded-pill shadow-sm text-white">
                <i class="bi bi-file-pdf-fill"></i> Descargar PDF
            </button>
        </div>
    </div>

    <div id="history-report" class="bg-white p-4 rounded-3 shadow-sm border">

        <div class="report-header border-bottom pb-3 mb-4">
            <div class="row align-items-end">
                <div class="col-6">
                    <h3 class="fw-bold text-dark mb-0">WeightControl</h3>
                    <p class="text-secondary small mb-0 text-uppercase ls-1">Informe de Evolución Ponderal</p>
                </div>
                <div class="col-6 text-end">
                    <h5 class="fw-bold mb-0 text-uppercase">{{ session.get('name', 'Paciente') }}</h5>
                    <p class="text-muted small mb-0">Generado: <span id="report-date-header"></span></p>
                    <p class="text-muted small mb-0 fw-bold text-primary">{{ filter_label }}</p>
                </div>
            </div>
        </div>

        <div class="medical-summary p-3 mb-4 rounded-2 border bg-light">
            <h6 class="fw-bold text-uppercase text-secondary small mb-3 border-bottom pb-2">Resumen del Periodo</h6>
            <div class="row text-center g-3">
                <div class="col-3 border-end">
                    <small class="text-muted d-block">Peso Actual</small>
                    <span class="fw-bold fs-5">{{ stats.current_weight }} </span>kg
                </div>
                <div class="col-3 border-end">
                    <small class="text-muted d-block">IMC Actual</small>
                    <span class="fw-bold fs-5 ">{{ stats.bmi }}</span>
                </div>
                <div class="col-3 border-end">
                    <small class="text-muted d-block">Cambio Total</small>
                    <span class="fw-bold fs-5 ">
                        {{ stats.total_change }}
                    </span>
                    kg
                </div>
                <div class="col-3">
                    <small class="text-muted d-block">Prom. Mensual</small>
                    <span class="fw-bold fs-5 text-dark">{{ stats.avg_monthly_change }}</span> kg/mes
                </div>
            </div>
            <div class="row mt-3 pt-2 border-top small text-muted">
                <div class="col-6">Altura registrada: <strong>{{ stats.height }} cm</strong></div>
                <div class="col-6 text-end">Días evaluados: <strong>{{ stats.days_elapsed }} días</strong></div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-sm table-striped table-hover align-middle mb-0 report-table">
                <thead class="table-light border-top border-bottom">
                    <tr>
                        <th class="ps-3 py-2">Fecha</th>
                        <th class="py-2">Peso (kg)</th>
                        <th class="py-2">IMC</th>
                        <th class="py-2 text-end">Dif</th>
                        <th class="text-end pe-3 py-2 no-print" style="width: 80px;">Edit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in weight_history %}
                    <tr>
                        <td class="ps-3 font-monospace small">
                            {{ entry.recorded_date.strftime('%d/%m/%Y') }}
                        </td>
                        <td class="fw-bold text-dark">
                            {{ entry.weight }}
                        </td>
                        <td class="small">
                            {{ entry.imc if entry.imc else '-' }}
                        </td>
                        <td class="text-end font-monospace small">
                            {% if entry.variation is not none %}
                                {% if entry.variation < 0 %}
                                    <span class="text-success">{{ entry.variation }} ▼</span>
                                {% elif entry.variation > 0 %}
                                    <span class="text-danger">+{{ entry.variation }} ▲</span>
                                {% else %}
                                    <span class="text-muted">=</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-end pe-3 no-print">
                            <div class="d-flex justify-content-end gap-3">
                                <button class="btn btn-link p-0 text-primary text-opacity-75"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editModal"
                                        data-url="{{ url_for('main.edit_weight', entry_id=entry._id) }}"
                                        data-weight="{{ entry.weight }}"
                                        data-date="{{ entry.recorded_date.strftime('%Y-%m-%d') }}"
                                        title="Editar">
                                    <i class="bi bi-pencil-square"></i>
                                </button>

                                <button class="btn btn-link p-0 text-danger text-opacity-75"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteModal"
                                        data-url="{{ url_for('main.delete_weight', entry_id=entry._id) }}"
                                        data-weight="{{ entry.weight }}"
                                        data-date="{{ entry.recorded_date.strftime('%d/%m/%Y') }}"
                                        title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">
                            No hay registros para este periodo.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-4 pt-2 border-top text-center printing-footer" style="display:none;">
            <p class="text-muted small mb-0">Reporte generado automáticamente por WeightControl.</p>
        </div>
    </div>
</div>

{% include 'main/partials/history_modals.html' %}
<div id="userData" data-username="{{ session.get('name', 'Usuario') }}" style="display:none;"></div>

{% endblock %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/history.js') }}"></script>
{% endblock %}